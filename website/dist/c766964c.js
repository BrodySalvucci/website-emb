var P=Object.defineProperty;var B=(r,a,e)=>a in r?P(r,a,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[a]=e;var b=(r,a,e)=>(B(r,typeof a!="symbol"?a+"":a,e),e);const N=globalThis.fetch,y=globalThis.WebSocket,j=globalThis.Request,T=globalThis.Response,S={prototype:{send:y.prototype.send},CLOSED:y.CLOSED,CLOSING:y.CLOSING,CONNECTING:y.CONNECTING,OPEN:y.OPEN},W=20,$=[101,204,205,304],F=[301,302,303,307,308];class D extends Error{constructor(e,t){super(t.message||t.code);b(this,"status");b(this,"body");this.status=e,this.body=t}}class G{constructor(a,e){b(this,"base");this.base=new URL(`./v${a}/`,e)}}function E(r,a){const e=(r&65535)+(a&65535);return(r>>16)+(a>>16)+(e>>16)<<16|e&65535}function q(r,a){return r<<a|r>>>32-a}function O(r,a,e,t,s,n){return E(q(E(E(a,r),E(t,n)),s),e)}function f(r,a,e,t,s,n,o){return O(a&e|~a&t,r,a,s,n,o)}function h(r,a,e,t,s,n,o){return O(a&t|e&~t,r,a,s,n,o)}function u(r,a,e,t,s,n,o){return O(a^e^t,r,a,s,n,o)}function w(r,a,e,t,s,n,o){return O(e^(a|~t),r,a,s,n,o)}function H(r,a){r[a>>5]|=128<<a%32,r[(a+64>>>9<<4)+14]=a;let e=1732584193,t=-271733879,s=-1732584194,n=271733878;for(let o=0;o<r.length;o+=16){const i=e,d=t,p=s,c=n;e=f(e,t,s,n,r[o],7,-680876936),n=f(n,e,t,s,r[o+1],12,-389564586),s=f(s,n,e,t,r[o+2],17,606105819),t=f(t,s,n,e,r[o+3],22,-1044525330),e=f(e,t,s,n,r[o+4],7,-176418897),n=f(n,e,t,s,r[o+5],12,1200080426),s=f(s,n,e,t,r[o+6],17,-1473231341),t=f(t,s,n,e,r[o+7],22,-45705983),e=f(e,t,s,n,r[o+8],7,1770035416),n=f(n,e,t,s,r[o+9],12,-1958414417),s=f(s,n,e,t,r[o+10],17,-42063),t=f(t,s,n,e,r[o+11],22,-1990404162),e=f(e,t,s,n,r[o+12],7,1804603682),n=f(n,e,t,s,r[o+13],12,-40341101),s=f(s,n,e,t,r[o+14],17,-1502002290),t=f(t,s,n,e,r[o+15],22,1236535329),e=h(e,t,s,n,r[o+1],5,-165796510),n=h(n,e,t,s,r[o+6],9,-1069501632),s=h(s,n,e,t,r[o+11],14,643717713),t=h(t,s,n,e,r[o],20,-373897302),e=h(e,t,s,n,r[o+5],5,-701558691),n=h(n,e,t,s,r[o+10],9,38016083),s=h(s,n,e,t,r[o+15],14,-660478335),t=h(t,s,n,e,r[o+4],20,-405537848),e=h(e,t,s,n,r[o+9],5,568446438),n=h(n,e,t,s,r[o+14],9,-1019803690),s=h(s,n,e,t,r[o+3],14,-187363961),t=h(t,s,n,e,r[o+8],20,1163531501),e=h(e,t,s,n,r[o+13],5,-1444681467),n=h(n,e,t,s,r[o+2],9,-51403784),s=h(s,n,e,t,r[o+7],14,1735328473),t=h(t,s,n,e,r[o+12],20,-1926607734),e=u(e,t,s,n,r[o+5],4,-378558),n=u(n,e,t,s,r[o+8],11,-2022574463),s=u(s,n,e,t,r[o+11],16,1839030562),t=u(t,s,n,e,r[o+14],23,-35309556),e=u(e,t,s,n,r[o+1],4,-1530992060),n=u(n,e,t,s,r[o+4],11,1272893353),s=u(s,n,e,t,r[o+7],16,-155497632),t=u(t,s,n,e,r[o+10],23,-1094730640),e=u(e,t,s,n,r[o+13],4,681279174),n=u(n,e,t,s,r[o],11,-358537222),s=u(s,n,e,t,r[o+3],16,-722521979),t=u(t,s,n,e,r[o+6],23,76029189),e=u(e,t,s,n,r[o+9],4,-640364487),n=u(n,e,t,s,r[o+12],11,-421815835),s=u(s,n,e,t,r[o+15],16,530742520),t=u(t,s,n,e,r[o+2],23,-995338651),e=w(e,t,s,n,r[o],6,-198630844),n=w(n,e,t,s,r[o+7],10,1126891415),s=w(s,n,e,t,r[o+14],15,-1416354905),t=w(t,s,n,e,r[o+5],21,-57434055),e=w(e,t,s,n,r[o+12],6,1700485571),n=w(n,e,t,s,r[o+3],10,-1894986606),s=w(s,n,e,t,r[o+10],15,-1051523),t=w(t,s,n,e,r[o+1],21,-2054922799),e=w(e,t,s,n,r[o+8],6,1873313359),n=w(n,e,t,s,r[o+15],10,-30611744),s=w(s,n,e,t,r[o+6],15,-1560198380),t=w(t,s,n,e,r[o+13],21,1309151649),e=w(e,t,s,n,r[o+4],6,-145523070),n=w(n,e,t,s,r[o+11],10,-1120210379),s=w(s,n,e,t,r[o+2],15,718787259),t=w(t,s,n,e,r[o+9],21,-343485551),e=E(e,i),t=E(t,d),s=E(s,p),n=E(n,c)}return[e,t,s,n]}function M(r){let a="";const e=r.length*32;for(let t=0;t<e;t+=8)a+=String.fromCharCode(r[t>>5]>>>t%32&255);return a}function v(r){const a=[],e=r.length>>2;for(let s=0;s<e;s+=1)a[s]=0;const t=r.length*8;for(let s=0;s<t;s+=8)a[s>>5]|=(r.charCodeAt(s/8)&255)<<s%32;return a}function J(r){return M(H(v(r),r.length*8))}function V(r,a){let e=v(r);const t=[],s=[];e.length>16&&(e=H(e,r.length*8));for(let o=0;o<16;o+=1)t[o]=e[o]^909522486,s[o]=e[o]^1549556828;const n=H(t.concat(v(a)),512+a.length*8);return M(H(s.concat(n),512+128))}function U(r){const a="0123456789abcdef";let e="";for(let t=0;t<r.length;t+=1){const s=r.charCodeAt(t);e+=a.charAt(s>>>4&15)+a.charAt(s&15)}return e}function L(r){return unescape(encodeURIComponent(r))}function A(r){return J(L(r))}function X(r){return U(A(r))}function I(r,a){return V(L(r),L(a))}function Y(r,a){return U(I(r,a))}function _(r,a,e){return a?e?I(a,r):Y(a,r):e?A(r):X(r)}const R=3072;function z(r){const a=new Headers(r);if(r.has("x-bare-headers")){const e=r.get("x-bare-headers");if(e.length>R){a.delete("x-bare-headers");let t=0;for(let s=0;s<e.length;s+=R){const n=e.slice(s,s+R),o=t++;a.set(`x-bare-headers-${o}`,`;${n}`)}}}return a}function K(r){const a=new Headers(r),e="x-bare-headers";if(r.has(`${e}-0`)){const t=[];for(const[s,n]of r){if(!s.startsWith(e))continue;if(!n.startsWith(";"))throw new D(400,{code:"INVALID_BARE_HEADER",id:`request.headers.${s}`,message:"Value didn't begin with semi-colon."});const o=parseInt(s.slice(e.length+1));t[o]=n.slice(1),a.delete(s)}a.set(e,t.join(""))}return a}class Q extends G{constructor(e){super(3,e);b(this,"ws");b(this,"http");this.ws=new URL(this.base),this.http=new URL(this.base),this.ws.protocol==="https:"?this.ws.protocol="wss:":this.ws.protocol="ws:"}connect(e,t,s,n,o){const i=new y(this.ws),d=()=>{i.removeEventListener("close",p),i.removeEventListener("message",c)},p=()=>{d()},c=l=>{if(d(),typeof l.data!="string")throw new TypeError("the first websocket message was not a text frame");const g=JSON.parse(l.data);if(g.type!=="open")throw new TypeError("message was not of open type");l.stopImmediatePropagation(),n({protocol:g.protocol,setCookies:g.setCookies}),o(S.OPEN),i.dispatchEvent(new Event("open"))};return i.addEventListener("close",p),i.addEventListener("message",c),i.addEventListener("open",l=>{l.stopImmediatePropagation(),o(S.CONNECTING),s().then(g=>S.prototype.send.call(i,JSON.stringify({type:"connect",remote:e.toString(),protocols:t,headers:g,forwardHeaders:[]})))},{once:!0}),i}async request(e,t,s,n,o,i,d){if(n.protocol.startsWith("blob:")){const m=await N(n),k=new T(m.body,m);return k.rawHeaders=Object.fromEntries(m.headers),k.rawResponse=m,k}const p={};if(t instanceof Headers)for(const[m,k]of t)p[m]=k;else for(const m in t)p[m]=t[m];const c={credentials:"omit",method:e,signal:d};o!=="only-if-cached"&&(c.cache=o),s!==void 0&&(c.body=s),i!==void 0&&(c.duplex=i),c.headers=this.createBareHeaders(n,p);const l=await N(this.http+"?cache="+_(n.toString()),c),g=await this.readBareResponse(l),C=new T($.includes(g.status)?void 0:l.body,{status:g.status,statusText:g.statusText??void 0,headers:new Headers(g.headers)});return C.rawHeaders=g.headers,C.rawResponse=l,C}async readBareResponse(e){if(!e.ok)throw new D(e.status,await e.json());const t=K(e.headers),s={},n=t.get("x-bare-status");n!==null&&(s.status=parseInt(n));const o=t.get("x-bare-status-text");o!==null&&(s.statusText=o);const i=t.get("x-bare-headers");return i!==null&&(s.headers=JSON.parse(i)),s}createBareHeaders(e,t,s=[],n=[],o=[]){const i=new Headers;i.set("x-bare-url",e.toString()),i.set("x-bare-headers",JSON.stringify(t));for(const d of s)i.append("x-bare-forward-headers",d);for(const d of n)i.append("x-bare-pass-headers",d);for(const d of o)i.append("x-bare-pass-status",d.toString());return z(i),i}}const Z="!#$%&'*+-.0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ^_`abcdefghijklmnopqrstuvwxyz|~";function x(r){for(let a=0;a<r.length;a++){const e=r[a];if(!Z.includes(e))return!1}return!0}const ee=[["v3",Q]];async function te(r,a){const e=await N(r,{signal:a});if(!e.ok)throw new Error(`Unable to fetch Bare meta: ${e.status} ${await e.text()}`);return await e.json()}const se=Object.getOwnPropertyDescriptor(y.prototype,"readyState").get,re=["ws:","wss:"];class ae{constructor(a,e){b(this,"manifest");b(this,"client");b(this,"server");b(this,"working");b(this,"onDemand");b(this,"onDemandSignal");this.server=new URL(a),!e||e instanceof AbortSignal?(this.onDemand=!0,this.onDemandSignal=e):(this.onDemand=!1,this.loadManifest(e))}loadManifest(a){return this.manifest=a,this.client=this.getClient(),this.client}demand(){return this.onDemand?(this.working||(this.working=te(this.server,this.onDemandSignal).then(a=>this.loadManifest(a)).catch(a=>{throw delete this.working,a})),this.working):this.client}getClient(){for(const[a,e]of ee)if(this.manifest.versions.includes(a))return new e(this.server);throw new Error("Unable to find compatible client version. Starting from v2.0.0, @tomphttp/bare-client only supports Bare servers v3+. For more information, see https://github.com/tomphttp/bare-client/")}createWebSocket(a,e=[],t){if(!this.client)throw new TypeError("You need to wait for the client to finish fetching the manifest before creating any WebSockets. Try caching the manifest data before making this request.");try{a=new URL(a)}catch{throw new DOMException(`Faiiled to construct 'WebSocket': The URL '${a}' is invalid.`)}if(!re.includes(a.protocol))throw new DOMException(`Failed to construct 'WebSocket': The URL's scheme must be either 'ws' or 'wss'. '${a.protocol}' is not allowed.`);Array.isArray(e)||(e=[e]),e=e.map(String);for(const c of e)if(!x(c))throw new DOMException(`Failed to construct 'WebSocket': The subprotocol '${c}' is invalid.`);const s=this.client.connect(a,e,async()=>{const c=typeof t.headers=="function"?await t.headers():t.headers||{},l=c instanceof Headers?Object.fromEntries(c):c;return l.Host=a.host,l.Pragma="no-cache",l["Cache-Control"]="no-cache",l.Upgrade="websocket",l.Connection="Upgrade",l},c=>{n=c.protocol,t.setCookiesCallback&&t.setCookiesCallback(c.setCookies)},c=>{o=c},t.webSocketImpl||y);let n="",o=S.CONNECTING;const i=()=>{const c=se.call(s);return c===S.OPEN?o:c};t.readyStateHook?t.readyStateHook(s,i):Object.defineProperty(s,"readyState",{get:i,configurable:!0,enumerable:!0});const d=()=>{if(i()===S.CONNECTING)return new DOMException("Failed to execute 'send' on 'WebSocket': Still in CONNECTING state.")};t.sendErrorHook?t.sendErrorHook(s,d):s.send=function(...c){const l=d();if(l)throw l;S.prototype.send.call(this,...c)},t.urlHook?t.urlHook(s,a):Object.defineProperty(s,"url",{get:()=>a.toString(),configurable:!0,enumerable:!0});const p=()=>n;return t.protocolHook?t.protocolHook(s,p):Object.defineProperty(s,"protocol",{get:p,configurable:!0,enumerable:!0}),s}async fetch(a,e){const t=ne(a)?new j(a,e):a,s=(e==null?void 0:e.headers)||t.headers,n=s instanceof Headers?Object.fromEntries(s):s,o=e==null?void 0:e.duplex,i=(e==null?void 0:e.body)||t.body;let d=new URL(t.url);const p=await this.demand();for(let c=0;;c++){"host"in n?n.host=d.host:n.Host=d.host;const l=await p.request(t.method,n,i,d,t.cache,o,t.signal);l.finalURL=d.toString();const g=(e==null?void 0:e.redirect)||t.redirect;if(F.includes(l.status))switch(g){case"follow":{const C=l.headers.get("location");if(W>c&&C!==null){d=new URL(C,d);continue}else throw new TypeError("Failed to fetch")}case"error":throw new TypeError("Failed to fetch");case"manual":return l}else return l}}}function ne(r){return typeof r=="string"||r instanceof URL}export{ae as B};
//# sourceMappingURL=c766964c.js.map
