{"version":3,"file":"cf3494b1.js","sources":["../../src/pages/compat/ultraviolet.tsx"],"sourcesContent":["import type { HolyPage } from '../../App';\nimport type { ScriptsRef } from '../../CompatLayout';\nimport { getDestination, Script, Scripts } from '../../CompatLayout';\nimport { BARE_API, SERVICEWORKERS } from '../../consts';\nimport { VITE_PUBLIC_PATH } from '../../routes';\nimport { useEffect, useRef } from 'react';\nimport { useTranslation } from 'react-i18next';\nimport { useLocation } from 'react-router-dom';\n\ntype UVEncode = (encoded: string) => string;\ntype UVDecode = (encoded: string) => string;\n\ninterface UVConfig {\n\tbare: string;\n\tprefix: string;\n\thandler: string;\n\tbundle: string;\n\tconfig: string;\n\tsw: string;\n\tencodeUrl: UVEncode;\n\tdecodeUrl: UVDecode;\n}\n\ndeclare const __uv$config: UVConfig;\n\nconst Ultraviolet: HolyPage = ({ compatLayout }) => {\n\tconst { t } = useTranslation('compat');\n\n\tconst uvBundle = useRef<ScriptsRef | null>(null);\n\tconst location = useLocation();\n\n\tuseEffect(() => {\n\t\t(async function () {\n\t\t\tif (!compatLayout.current || !uvBundle.current) return;\n\n\t\t\tlet errorCause: string | undefined;\n\n\t\t\ttry {\n\t\t\t\tif (!SERVICEWORKERS) {\n\t\t\t\t\terrorCause = t('error.swHTTPS');\n\t\t\t\t\tthrow new Error(errorCause);\n\t\t\t\t}\n\n\t\t\t\tif (!navigator.serviceWorker) {\n\t\t\t\t\terrorCause = t('error.swSupport');\n\t\t\t\t\tthrow new Error(errorCause);\n\t\t\t\t}\n\n\t\t\t\terrorCause = t('error.generic', { what: 'Ultraviolet' });\n\t\t\t\tawait uvBundle.current.promise;\n\t\t\t\terrorCause = undefined;\n\n\t\t\t\tconst config = __uv$config;\n\n\t\t\t\t// register sw\n\t\t\t\terrorCause = t('error.registeringSW');\n\t\t\t\tawait navigator.serviceWorker.register(`${VITE_PUBLIC_PATH}/uv/sw.js`, {\n\t\t\t\t\tscope: config.prefix,\n\t\t\t\t\tupdateViaCache: 'none',\n\t\t\t\t});\n\t\t\t\terrorCause = undefined;\n\n\t\t\t\terrorCause = t('error.unreachable', { what: 'Bare' });\n\t\t\t\t{\n\t\t\t\t\tconst bare = await fetch(BARE_API);\n\t\t\t\t\tif (!bare.ok) {\n\t\t\t\t\t\tthrow await bare.json();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\terrorCause = undefined;\n\n\t\t\t\tglobalThis.location.replace(\n\t\t\t\t\tnew URL(\n\t\t\t\t\t\tconfig.encodeUrl(getDestination(location)),\n\t\t\t\t\t\tnew URL(config.prefix, globalThis.location.toString()),\n\t\t\t\t\t),\n\t\t\t\t);\n\t\t\t} catch (err) {\n\t\t\t\tcompatLayout.current.report(err, errorCause, 'Ultraviolet');\n\t\t\t}\n\t\t})();\n\t}, [compatLayout, location, t]);\n\n\treturn (\n\t\t<main>\n\t\t\t<Scripts ref={uvBundle}>\n\t\t\t\t<Script src={`${import.meta.env.VITE_PUBLIC_PATH}/uv/uv.bundle.js`} />\n\t\t\t\t<Script src={`${import.meta.env.VITE_PUBLIC_PATH}/uv/uv.config.js`} />\n\t\t\t</Scripts>\n\t\t\t{t('loading', { what: 'Ultraviolet' })}\n\t\t</main>\n\t);\n};\n\nexport default Ultraviolet;\n"],"names":["Ultraviolet","compatLayout","t","useTranslation","uvBundle","useRef","location","useLocation","useEffect","errorCause","SERVICEWORKERS","config","VITE_PUBLIC_PATH","bare","BARE_API","getDestination","err","jsxs","Scripts","jsx","Script"],"mappings":"yGAyBA,MAAMA,EAAwB,CAAC,CAAE,aAAAC,KAAmB,CACnD,KAAM,CAAE,EAAAC,CAAA,EAAMC,EAAe,QAAQ,EAE/BC,EAAWC,SAA0B,IAAI,EACzCC,EAAWC,IAEjBC,OAAAA,EAAAA,UAAU,IAAM,EACd,gBAAkB,CAClB,GAAI,CAACP,EAAa,SAAW,CAACG,EAAS,QAAS,OAE5C,IAAAK,EAEA,GAAA,CACH,GAAI,CAACC,EACJ,MAAAD,EAAaP,EAAE,eAAe,EACxB,IAAI,MAAMO,CAAU,EAGvB,GAAA,CAAC,UAAU,cACd,MAAAA,EAAaP,EAAE,iBAAiB,EAC1B,IAAI,MAAMO,CAAU,EAG3BA,EAAaP,EAAE,gBAAiB,CAAE,KAAM,aAAe,CAAA,EACvD,MAAME,EAAS,QAAQ,QACVK,EAAA,OAEb,MAAME,EAAS,YAGfF,EAAaP,EAAE,qBAAqB,EACpC,MAAM,UAAU,cAAc,SAAS,GAAGU,CAAgB,YAAa,CACtE,MAAOD,EAAO,OACd,eAAgB,MAAA,CAChB,EACYF,EAAA,OAEbA,EAAaP,EAAE,oBAAqB,CAAE,KAAM,MAAQ,CAAA,EACpD,CACO,MAAAW,EAAO,MAAM,MAAMC,CAAQ,EAC7B,GAAA,CAACD,EAAK,GACH,MAAA,MAAMA,EAAK,MAEnB,CACaJ,EAAA,OAEb,WAAW,SAAS,QACnB,IAAI,IACHE,EAAO,UAAUI,EAAeT,CAAQ,CAAC,EACzC,IAAI,IAAIK,EAAO,OAAQ,WAAW,SAAS,UAAU,CACtD,CAAA,QAEOK,EAAK,CACbf,EAAa,QAAQ,OAAOe,EAAKP,EAAY,aAAa,CAC3D,CAAA,IAEC,EAAA,CAACR,EAAcK,EAAUJ,CAAC,CAAC,SAG5B,OACA,CAAA,SAAA,CAACe,EAAAA,KAAAC,EAAA,CAAQ,IAAKd,EACb,SAAA,CAAAe,EAAA,IAACC,GAAO,IAAK,mBAAuD,QACnEA,EAAO,CAAA,IAAK,mBAAuD,CAAA,EACrE,EACClB,EAAE,UAAW,CAAE,KAAM,cAAe,CACtC,CAAA,CAAA,CAEF"}