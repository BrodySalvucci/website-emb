var w=Object.defineProperty;var g=(n,e,t)=>e in n?w(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var h=(n,e,t)=>(g(n,typeof e!="symbol"?e+"":e,t),t);import{u as v,b as x,r as S,R as d,c as y,j as R}from"./assets/index-25a0d8c7.js";class C{constructor(e,t,r){h(this,"server");h(this,"signal");h(this,"password");this.server=e,this.signal=t,this.password=r}async get(e){this.password&&(e.includes("?")?e+="&pwd="+this.password:e+="?pwd="+this.password);try{const t=await fetch(new URL(e,this.server),{signal:this.signal});if(t.status===200)return await t.text();throw new Error(`unexpected server response to not match "200". Server says "${await t.text()}"`)}catch(t){throw console.error(t),new Error("Cannot communicate with the server")}}async needPassword(){return await this.get("needpassword")==="true"}async newSession(){return await this.get("newsession")}async editSession(e,t,r){const s=await this.get("editsession?id="+encodeURIComponent(e)+(t?"&httpProxy="+encodeURIComponent(t):"")+"&enableShuffling="+(r?"1":"0"));if(s!=="Success")throw new Error(`unexpected response from server. received ${s}`)}async sessionExists(e){const t=await this.get("sessionexists?id="+encodeURIComponent(e));switch(t){case"exists":return!0;case"not found":return!1;default:throw new Error(`unexpected response from server. received ${t}`)}}async deleteSession(e){if(await this.sessionExists(e)){const t=await this.get("deletesession?id="+e);if(t!=="Success"&&t!=="not found")throw new Error(`unexpected response from server. received ${t}`)}}async shuffleDict(e){const t=await this.get("api/shuffleDict?id="+encodeURIComponent(e));return JSON.parse(t)}}class D{constructor(e){h(this,"dictionary");h(this,"baseDictionary","0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz~-");h(this,"shuffledIndicator","_rhs");e||(e=this.generateDictionary()),this.dictionary=e}mod(e,t){return(e%t+t)%t}generateDictionary(){let e="";const t=this.baseDictionary.split("");for(;t.length>0;)e+=t.splice(Math.floor(Math.random()*t.length),1)[0];return e}shuffle(e){if(e.startsWith(this.shuffledIndicator))return e;let t="";for(let r=0;r<e.length;r++){const s=e.charAt(r),i=this.baseDictionary.indexOf(s);s==="%"&&e.length-r>=3?(t+=s,t+=e.charAt(++r),t+=e.charAt(++r)):i===-1?t+=s:t+=this.dictionary.charAt(this.mod(i+r,this.baseDictionary.length))}return this.shuffledIndicator+t}unshuffle(e){if(!e.startsWith(this.shuffledIndicator))return e;e=e.slice(this.shuffledIndicator.length);let t="";for(let r=0;r<e.length;r++){const s=e.charAt(r),i=this.dictionary.indexOf(s);s==="%"&&e.length-r>=3?(t+=s,t+=e.charAt(++r),t+=e.charAt(++r)):i===-1?t+=s:t+=this.baseDictionary.charAt(this.mod(i-r,this.baseDictionary.length))}return t}}/*! js-cookie v3.0.5 | MIT */function l(n){for(var e=1;e<arguments.length;e++){var t=arguments[e];for(var r in t)n[r]=t[r]}return n}var I={read:function(n){return n[0]==='"'&&(n=n.slice(1,-1)),n.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent)},write:function(n){return encodeURIComponent(n).replace(/%(2[346BF]|3[AC-F]|40|5[BDE]|60|7[BCD])/g,decodeURIComponent)}};function u(n,e){function t(s,i,o){if(!(typeof document>"u")){o=l({},e,o),typeof o.expires=="number"&&(o.expires=new Date(Date.now()+o.expires*864e5)),o.expires&&(o.expires=o.expires.toUTCString()),s=encodeURIComponent(s).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape);var a="";for(var c in o)o[c]&&(a+="; "+c,o[c]!==!0&&(a+="="+o[c].split(";")[0]));return document.cookie=s+"="+n.write(i,s)+a}}function r(s){if(!(typeof document>"u"||arguments.length&&!s)){for(var i=document.cookie?document.cookie.split("; "):[],o={},a=0;a<i.length;a++){var c=i[a].split("="),m=c.slice(1).join("=");try{var f=decodeURIComponent(c[0]);if(o[f]=n.read(m,f),s===f)break}catch{}}return s?o[s]:o}}return Object.create({set:t,get:r,remove:function(s,i){t(s,"",l({},i,{expires:-1}))},withAttributes:function(s){return u(this.converter,l({},this.attributes,s))},withConverter:function(s){return u(l({},this.converter,s),this.attributes)}},{attributes:{value:Object.freeze(e)},converter:{value:Object.freeze(n)}})}var p=u(I,{path:"/"});function E(n){return n.replace(/(^.*?:\/)\//,"$1")}const b=({compatLayout:n})=>{const{t:e}=v("compat"),t=x();return S.useEffect(()=>{(async function(){let r;try{const s=new C(d);if({}.NODE_ENV==="production"&&(p.set("auth_proxy","1",{domain:`.${globalThis.location.host}`,expires:1e3*60*60*24*7,secure:globalThis.location.protocol==="https:",sameSite:"lax"}),p.set("origin_proxy",globalThis.location.origin,{expires:1e3*60*60*24*7,secure:globalThis.location.protocol==="https:",sameSite:"lax"})),r=e("error.unreachable",{what:"Rammerhead"}),await fetch(d),r=void 0,r=e("error.rammerheadSavedSession"),localStorage.rammerhead_session&&await s.sessionExists(localStorage.rammerhead_session)){const c=await fetch(new URL(localStorage.rammerhead_session,d));await s.deleteSession(localStorage.rammerhead_session),c.status===403&&delete localStorage.rammerhead_session}else delete localStorage.rammerhead_session;r=e("error.rammerheadNewSession");const i=localStorage.rammerhead_session||await s.newSession();r=void 0,r=void 0,r=e("error.rammerheadEditSession"),await s.editSession(i,!1,!0),r=void 0,r=e("error.rammerheadDict");const o=await s.shuffleDict(i);r=void 0;const a=new D(o);globalThis.location.replace(new URL(`${i}/${E(a.shuffle(y(t)))}`,d))}catch(s){n.current.report(s,r,"Rammerhead")}})()},[n,t,e]),R.jsx("main",{children:e("loading",{what:"Rammerhead"})})};export{b as default};
//# sourceMappingURL=9fd87f4b.js.map
